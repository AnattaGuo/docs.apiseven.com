---
title: 高可用
slug: /生产实践/高可用
tags:
  - API7 Enterprise
---
本文将指导你如何部署具备高可用性的API7 Enter。我们将以构建一个最小可用的高可用性架构为例进行演示，包括数据面(Data Plane)的高可用、控制面(Control Plane)的高可用和etcd集群的高可用。

# 部署架构
用以下组件建立一个高可用架构（最小可用版）。

![](https://static.apiseven.com/uploads/2023/03/16/wPEDJzYG_high_availability_architecture.png)

- 数据面(Data Plane)的高可用是必要的。当数据面上发生一些可预见的故障时，应该保证业务API不中断。我们强烈建议部署两个以上的数据面(Data Plane)实例以防止单点故障。
- etcd的高可用是必要的，因为etcd存储着重要的数据和配置。根据etcd Raft协议，最小的etcd集群需要至少三个节点。
- 控制面(Control Plane)的高可用是可选的。当控制面(Control Plane)发生故障时，你将无法修改API网关的配置，但它不会影响已在运行的业务API请求。因此，如果需要控制成本且可接受风险，可以只部署一个控制面(Control Plane)实例。

# 准备节点
我们通常需要至少七个节点（三个etcd节点+两个数据面节点+两个控制面节点）来完成高可用架构，但本文示例中我们只用了五个节点，通过将etcd集群和API7-Dashboard部署在同一个节点上来减少节点总数。在生产实践中，你可以根据你的预算来选择是否混部以节约节点，或增加更多节点提供更好的保障。

对于每个节点，我们的最低配置要求如下。

| **主机名**             | **部署组件**          | **开放端口**     | **节点规格**       | **操作系统**       | **Docker版本**  |
| :----------------------| :------------------- | :-------------- | :---------------- | :------------------| :------------- |
| api7-highavailability1 | etcd、API7-Dashboard | 9000、2379、2380 |  2C4G             | Centos 7.6及以上   | 20.10.7及以上   |
| api7-highavailability2 | etcd、API7-Dashboard | 9000、2379、2380 |  2C4G             | Centos 7.6及以上   | 20.10.7及以上   |
| api7-highavailability3 | etcd                 | 2379、2380       |  2C4G             | Centos 7.6及以上   | 20.10.7及以上   |
| api7-highavailability4 | API7-Gateway         | 80、443、9091    |  2C4G             | Centos 7.6及以上   | 20.10.7及以上   |
| api7-highavailability5 | API7-Gateway         | 80、443、9091    |  2C4G             | Centos 7.6及以上   | 20.10.7及以上   |

### 关于操作系统和Docker版本选择
Docker使用20.10.7及以上，已知它与3.10.0-327（CentOS 7.2）及以下版本不兼容。建议使用3.10.0-927（CentOS 7.6）或更高版本。可以执行以下命令检查当前内核版本号。
```sh
$ uname -a
Linux api7-highavailability1 3.10.0-1160.76.1.el7.x86_64 #1 SMP Wed Aug 10 16:21:17 UTC 2022 x86_64 x86_64 x86_64 x86_64 GNU/Linux
```
可以用以下命令升级内核版本:
```sh
yum update -y kernel
```
### 安全配置
在每个节点上配置SELinux和防火墙服务（firewalld或iptables），以允许对端口的访问。

### 开放端口
- API7-Gateway :
  - 80: HTTP访问。
  - 443: HTTPs访问。
  - 9091: 连接Prometheus监控。
- API7-Dashboard:
  - 9000: API7 Enterprise控制台入口。
- etcd:
  - 2379:对外提供数据和配置的端口。
  - 2380:集群环境下用于 Peer 通讯的端口。

# 安装软件
请确保每个节点都安装了Docker和Docerk-compose。

Docker安装: https://docs.docker.com/engine/install/centos/

Docker-compose安装: https://docs.docker.com/desktop/install/linux-install/

# 下载API7 Enterprise
https://api7.ai/try?product=enterprise

# 导出ip（可选）
Avoid modifying the ips manually in the following steps by exporting the machine ip in advance.
```sh
export ha_ip1=${your_host_ip1}
export ha_ip2=${your_host_ip2}
export ha_ip3=${your_host_ip3}
export ha_ip4=${your_host_ip4}
export ha_ip5=${your_host_ip5}
```
# Deploy etcd with high availability
**Step1**:Install Docker on three etcd nodes:api7-highavailability1、api7-highavailability2、api7-highavailability3.

**Step2**:Login api7-highavailability1、api7-highavailability2、api7-highavailability，create 'etcd_data' directory.
```sh
sudo mkdir -p /usr/local/etcd/etcd_data
```
**Step3**:Start three etcd nodes
```sh
sudo docker run --restart always --name etcd -u root -v /usr/local/etcd/etcd_data:/etcd_data -e ALLOW_NONE_AUTHENTICATION=yes -e ETCD_NAME=api7-etcd-1 -e ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380 -e ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379 -e ETCD_ADVERTISE_CLIENT_URLS=http://$ha_ip1:2379 -e ETCD_INITIAL_ADVERTISE_PEER_URLS=http://$ha_ip1:2380 -e ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster -e ETCD_INITIAL_CLUSTER=api7-etcd-1=http://$ha_ip1:2380,api7-etcd-2=http://$ha_ip2:2380,api7-etcd-3=http://$ha_ip3:2380 -e ETCD_DATA_DIR=/etcd_data -e ETCD_ENABLE_V2=true --network=host -d bitnami/etcd:3.4.13
```

**Step4**:Verify your deployment
```sh
$ docker exec etcd bash -c "etcdctl --endpoints $ha_ip1:2379,$ha_ip2:2379,$ha_ip3:2379 endpoint health"
172.28.0.14:2379 is healthy: successfully committed proposal: took = 1.468755ms
172.28.0.16:2379 is healthy: successfully committed proposal: took = 2.154079ms
172.28.0.15:2379 is healthy: successfully committed proposal: took = 3.133916ms
```

# Deploy control plane with high availability（Optional）

If you don't need high availability of control plane then only deploy on one node(For example, api7-highavailability1).

**Step1**:Install Docker on two control plane nodes:api7-highavailability1、api7-highavailability2.

**Step2**:Copy api7-2.13.2209.1-cp.tar.gz(or lower version,please refer to your download) to two control plane nodes and decompress:
```sh
# decompress
tar -zxvf api7-2.13.2209.1-cp.tar.gz
# load docker image
docker load < images/api7-dashboard-2.13.2209.1.tar.gz
```
**Step3**:Deploy API7-Dashboard
```sh
# Login to api7-highavailability1、api7-highavailability2 ，modify etcd cluster configuration
# vim dashboard_conf/conf.yaml
conf:
  etcd:
    name: "default"
    endpoints:
      - ${ha_ip1}:2379
      - ${ha_ip2}:2379
      - ${ha_ip3}:2379
    enable_auth: false
    username: "root"      # ignore etcd username if not enable etcd auth
    password: "123456"    # ignore etcd password if not enable etcd auth
    mtls:
      enable: false
      key_file: ""          # Path of your self-signed client side key
      cert_file: ""         # Path of your self-signed client side cert
      ca_file: ""           # Path of your self-signed ca cert, the CA is used to sign callers' certificates
    prefix: /api7           # key prefix in etcd
```
**Step4**:Start API7-Dashboard
```sh
docker compose up api7-dashboard -d
```

**Step5**: Veriry API7-Dashboard
```sh
# Check the container list and the logs.
$ docker ps 
CONTAINER ID   IMAGE                                          COMMAND                  CREATED         STATUS        PORTS                                       NAMES
17a250b6f6d5   api7ee.azurecr.io/api7-dashboard:2.13.2209.1   "/usr/local/apisix-d…"   2 seconds ago   Up 1 second   0.0.0.0:9000->9000/tcp, :::9000->9000/tcp   api7-21322091-cp-api7-dashboard-1
2166063e6f7e   bitnami/etcd:3.4.13                            "/entrypoint.sh etcd"    6 hours ago     Up 6 hours                                                etcd
[xxx@api7-highavailability1 api7-2.13.2209.1-cp]$ docker logs -f 17a250b6f6d5
The manager-api is running successfully!

Version : 2.13.2209.1
GitHash : f2c8f46
Listen  : 0.0.0.0:9000
Loglevel: warn
Logfile : /usr/local/apisix-dashboard/logs/error.log
```

**Step6**: Login to the API7 Enterprise console, create a new cluster and test.

# Deploy data plane with high availaibility

**Step1**:Install Docker on two data plane nodes:api7-highavailability4、api7-highavailability5

**Step2**:Copy api7-2.13.2209.1-dp.tar.gz(or lower version,please refer to your download) to two data plane nodes and decompress
```sh
# decompress
tar -zxvf api7-2.13.2209.1-dp.tar.gz
# load docker image
docker load < images/api7-gateway-2.13.2209.2.tar.gz
```

**Step3**:Deploy API7-Gateway:
```sh
# Login to api7-highavailability4、api7-highavailability5 ，modify API7-Gateway configuration
# vim gateway_conf/config.yaml
etcd:
  host:
    - ${ha_ip1}:2379
    - ${ha_ip2}:2379
    - ${ha_ip3}:2379
  prefix: /api7/${cluster_id} 
```

**Step4**:Start API7-Gateway
```sh
docker compose up -d
```

**Step5**:Verify API7-Gateway:
```sh
# Login to api7-highavailability4、api7-highavailability5 ，modify API7-Gateway configuration
$ curl 172.28.0.17:80/get -H "Host: test.com"
{
  "args": {}, 
  "headers": {
    "Accept": "*/*", 
    "Host": "test.com", 
    "User-Agent": "curl/7.29.0", 
    "X-Amzn-Trace-Id": "Root=1-63e46ced-6c448fe974210a5f327d268e", 
    "X-Forwarded-Host": "test.com"
  }, 
  "origin": "172.28.0.16, 20.39.184.151", 
  "url": "http://test.com/get"
}
```

# Verify overall high availability
We need to mount a control plane load balancer before the two API7-Dashboard services and a data plane load balancer before the two API7-Gateway services. Any load balancer product is fine.

Check the following three scenarios to verify the high availability of API7 Enterprise.

## Manually disable the API7-Gateway service on api7-highavailability4
```sh
[xxx@api7-highavailability4 ~]$ cd api7-2.13.2209.1-dp/
[xxx@api7-highavailability4 api7-2.13.2209.1-dp]$ ls
cli.sh  docker-compose.yaml  gateway_conf  gateway_logs  images
[zwx@api7-highavailability4 api7-2.13.2209.1-dp]$ docker compose down 
[+] Running 2/2
 ⠿ Container api7-21322091-dp-api7-gateway-1  Removed                                                                                                                       10.2s
 ⠿ Network api7-21322091-dp_api7              Removed                                                                                                                        0.0s
[zwx@api7-highavailability4 api7-2.13.2209.1-dp]$ docker ps 
CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES
```

Then try to access the data plane load balancer to see if the API7-Gateway service is working.

## Manually disable the API7-Dashboard service on api7-highavailability1
```sh
$ cd api7-2.13.2209.1-cp/
$ docker compose down
```

Then try to access the control plane load balancer to see if the API7-Dashboard service is working.

## Manually disable the ETCD service on api7-highavailability1
```sh
[xxx@api7-highavailability1 api7-2.13.2209.1-cp]$ docker ps 
CONTAINER ID   IMAGE                                          COMMAND                  CREATED         STATUS         PORTS                                       NAMES
d3b572696f50   api7ee.azurecr.io/api7-dashboard:2.13.2209.1   "/usr/local/apisix-d…"   4 minutes ago   Up 4 minutes   0.0.0.0:9000->9000/tcp, :::9000->9000/tcp   api7-21322091-cp-api7-dashboard-1
2166063e6f7e   bitnami/etcd:3.4.13                            "/entrypoint.sh etcd"    24 hours ago    Up 24 hours                                                etcd
[xxx@api7-highavailability1 api7-2.13.2209.1-cp]$ docker stop 2166063e6f7e
2166063e6f7e
[xxx@api7-highavailability1 api7-2.13.2209.1-cp]$ docker ps 
CONTAINER ID   IMAGE                                          COMMAND                  CREATED         STATUS         PORTS                                       NAMES
d3b572696f50   api7ee.azurecr.io/api7-dashboard:2.13.2209.1   "/usr/local/apisix-d…"   4 minutes ago   Up 4 minutes   0.0.0.0:9000->9000/tcp, :::9000->9000/tcp   api7-21322091-cp-api7-dashboard-1
```

Then try to access the control plane load balancer, then read and write data.


