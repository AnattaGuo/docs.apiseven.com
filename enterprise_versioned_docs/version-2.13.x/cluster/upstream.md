---
title: 上游管理
slug: /集群管理/上游管理
tags:
  - API7 Enterprise
---

## 名词解释

#### 上游名称

帮助用户识别不同上游。

#### 上游类型

上游使用的负载均衡算法的类型。

#### 上游描述

对上游的进一步说明，通常包括用途定位、使用注意事项等。

#### 负载均衡算法

目前支持以下算法：
- roundrobin - 带权轮询。
- chash - 带权一致性哈希。
- ewma - 指数加权移动平均法，选择延迟最小的节点。[参考EWMA chart](https://en.wikipedia.org/wiki/EWMA_chart)。
- least_conn - 最小连接数。选择 (active_conn + 1) / weight 最小的节点。此处的 active connection 概念跟 NGINX 的相同，它是当前正在被请求使用的连接。

#### 目标节点

上游的服务节点，网关转发流量的实际去处。必须是固定不变的静态节点，可以是ip地址或者域名。

如果所有目标节点都为空，则上游会返回`502`状态码。

#### 权重

用于负载均衡算法的节点权重，影响节点的选择。

#### Host请求头

可以选择与客户端保持一致的主机名，或使用目标节点列表中的主机名或IP.

#### 重试次数

使用 NGINX 重试机制将请求传递给下一个上游，默认启用重试机制且次数为后端可用的节点数量。如果指定了具体重试次数，它将覆盖默认值。当设置为 0 时，表示不启用重试机制。如果不填写任何值，则将使用目标节点的数量。

#### 协议

跟上游通信时使用的 scheme。对于 7 层代理，可选值为 [http, https, grpc, grpcs]。默认值为 http。

#### 连接超时

建立从请求到上游服务器的连接的超时时间。

#### 发送超时

发送数据到上游服务器的超时时间。

#### 接收超时

从上游服务器接收数据的超时时间。

#### 健康检查-主动检查

主动健康检查主要是指通过预设的探针类型，主动探测上游节点的存活性。目前支持 HTTP、HTTPS、TCP 三种探针类型。

当发向健康节点 A 的 N 个连续探针都失败时（取决于如何配置），则该节点将被标记为不健康，不健康的节点将会被负载均衡器忽略，无法收到请求；若某个不健康的节点，连续 M 个探针都成功，则该节点将被重新标记为健康，进而可以被代理。

#### 健康检查-主动检查-类型

执行主动健康检查的探针类型，目前支持 HTTP、HTTPS、TCP 三种。

#### 健康检查-主动检查-超时时间

主动健康检查的套接字的超时时间。

#### 健康检查-主动检查-并行数量

在主动健康检查中同时检查的目标节点数量。

#### 健康检查-主动检查-主机名

进行主动健康检查时使用的 HTTP 请求主机名。若使用 TCP 无需填写。

#### 健康检查-主动检查-端口

主动检查的 HTTP 请求主机端口。

#### 健康检查-主动检查-请求路径

向目标节点发出 HTTP 请求时应使用的路径。

#### 健康检查-主动检查-请求头

主动检查使用 HTTP 或 HTTPS 类型检查时，设置额外的请求头信息。

#### 健康检查-主动检查-健康状态-间隔时间

对健康的上游服务目标节点进行主动健康检查的间隔时间（以秒为单位）。数值为0表示对健康节点不进行主动健康检查。

#### 健康检查-主动检查-健康状态-成功次数

主动健康检查的 HTTP 成功次数，若达到此值，表示上游服务目标节点是健康的。

#### 健康检查-主动检查-健康状态-状态码

HTTP 状态码列表，当探针在主动健康检查中返回时，视为健康。

#### 健康检查-主动检查-不健康状态-超时时间

活动探针中认为目标不健康的超时次数。

#### 健康检查-主动检查-不健康状态-间隔时间

对不健康目标的主动健康检查之间的间隔（以秒为单位）。

#### 健康检查-主动检查-不健康状态-状态码

HTTP 状态码列表，当探针在主动健康检查中返回时，视为不健康。

#### 主健康检查-主动检查-不健康状态-HTTP失败次数

主动健康检查的 HTTP 失败次数，默认值为0。若达到此值，表示上游服务目标节点是不健康的。

#### 健康检查-主动检查-不健康状态-TCP失败次数

主动探测中 TCP 失败次数超过该值时，认为目标不健康。

#### 健康检查-被动检查

被动健康检查是指，通过判断从 API7 网关转发到上游节点的请求响应状态，来判断对应的上游节点是否健康。相对于主动健康检查，被动健康检查的方式无需发起额外的探针，但是也无法提前感知节点状态，可能会有一定量的失败请求。

若发向健康节点 A 的 N 个连续请求都被判定为失败（取决于如何配置），则该节点将被标记为不健康。

由于不健康的节点无法收到请求，仅使用被动健康检查策略无法重新将节点标记为健康，因此必须同时开启主动健康检查策略。

### 健康检查-被动检查-类型

执行被动健康检查的探针类型，目前支持 HTTP、HTTPS、TCP 三种，应当与上游的协议类型保持一致。

### 健康检查-被动检查-健康状态-状态码

HTTP 状态码列表，当探针在被动健康检查中返回时，视为健康。

### 健康检查-被动检查-健康状态-成功次数

被动健康检查的 HTTP 成功次数，若达到此值，表示上游服务目标节点是健康的。

### 健康检查-被动检查-不健康状态-超时次数

活动探针中认为目标不健康的超时次数。

### 健康检查-被动检查-不健康状态-TCP失败次数

被动探测中 TCP 失败次数超过该值时，认为目标不健康。

### 健康检查-被动检查-不健康状态-HTTP失败次数

被动健康检查的 HTTP 失败次数，默认值为0。若达到此值，表示上游服务目标节点是不健康的。


### 健康检查-被动检查-不健康状态-状态码

HTTP 状态码列表，当探针在被动健康检查中返回时，视为不健康。

## 新建上游
#### 使用场景

某个路由/API 需要转发到具体的后端服务，将此后端服务设置为一个上游。

### 使用限制

1. 每个路由/API 必须选择一个上游，不允许为空。
2. 一个上游可以被搭配多个路由/ API。

### 操作步骤

**步骤1**：登录 API7 Enterprise 控制台。

**步骤2**：在顶部导航菜单，点击`集群管理`。

**步骤3**：在左侧菜单，点击`集群列表`。

**步骤4**：点击对应集群的`访问`按钮。

**步骤5**：在左侧菜单，点击`工作分区`。

**步骤6**：点击对应工作分区的`访问`按钮。

**步骤7**：在左侧菜单，点击`上游管理`。

**步骤8**：点击`新建`按钮。

**步骤9**：根据名词解释，填写表单；

**步骤10**：点击`提交`按钮。

**验证方式**：在上游列表中，可以看到新的上游记录。

## 配置上游
#### 使用场景

编辑上游的属性。

#### 使用限制

编辑上游后，所有与之相关的路由/ API 都将受到影响。

#### 操作步骤

**步骤1**：登录 API7 Enterprise 控制台。

**步骤2**：在顶部导航菜单，点击`集群管理`。

**步骤3**：在左侧菜单，点击`集群列表`。

**步骤4**：点击对应集群的`访问`按钮。

**步骤5**：在左侧菜单，点击`工作分区`。

**步骤6**：点击对应工作分区的`访问`按钮。

**步骤7**：在左侧菜单，点击`上游管理`。

**步骤8**：点击对应上游的`配置`按钮。

**步骤9**：编辑上游的属性。

**步骤10**：点击`提交`按钮。

**验证方式**：与上游关联的路由/ API 的业务逻辑随之变化。

## 删除上游
#### 使用场景

上游对应的后端服务下线，不再使用。

#### 使用限制

必须先删除上游关联的所有路由/API。

#### 操作步骤


**步骤1**：登录 API7 Enterprise 控制台。

**步骤2**：在顶部导航菜单，点击`集群管理`。

**步骤3**：在左侧菜单，点击`集群列表`。

**步骤4**：点击对应集群的`访问`按钮。

**步骤5**：在左侧菜单，点击`工作分区`。

**步骤6**：点击对应工作分区的`访问`按钮。

**步骤7**：在左侧菜单，点击`上游管理`。

**步骤8**：点击对应上游的`删除`按钮。

**验证方式**：在上游列表中，已看不到被删除的上游。